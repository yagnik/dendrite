#!/usr/bin/env ruby
require 'bundler/setup'
require 'dendrite'
require 'optparse'
require 'pry'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: register [options]"
  opts.on("-s", "--service SERVICE_NAME", "service name") do |v|
    options[:service_name] = v
  end

  opts.on("-c", "--config CONFIG_FILE", "config file") do |v|
    options[:config] = v
  end
end.parse!

Dendrite::Config.load(source: options[:config])
services = begin
  Dendrite::IO.read(source: Dendrite::Config.nerve_config_path)[:services].keys
rescue
  []
end.collect(&:to_s)
graph = Dendrite::IO.load(source: Dendrite::Config.services_source)

raise Dendrite::InvalidData unless graph.valid?
raise Dendrite::UnknownService unless services.collect {|service_name| graph[service_name]}.all?
raise Dendrite::UnknownService unless graph[options[:service_name]]

services << options[:service_name]
services.uniq!
synapse = Dendrite::Generators::Synapse.new(graph: graph, service_names: services)
Dendrite::IO.write(data: synapse.to_yaml, destination: Dendrite::Config.synapse_config_path)

nerve = Dendrite::Generators::Nerve.new(graph: graph, service_names: services)
Dendrite::IO.write(data: nerve.to_yaml, destination: Dendrite::Config.nerve_config_path)
